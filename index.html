<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>المتأخرات - نظام الفواتير</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #f8fafc; /* Lighter gray background */
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal:not(.is-open) {
            opacity: 0;
            visibility: hidden;
        }
        .modal.is-open {
            opacity: 1;
            visibility: visible;
        }
        .action-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 4px 10px; /* Adjusted padding for text */
            border-radius: 6px; /* Slightly less rounded */
            transition: background-color 0.2s, color 0.2s, opacity 0.2s;
            color: #475569; /* Slate 600 */
        }
        .action-button:hover:not(:disabled) {
            background-color: #f1f5f9; /* Slate 100 */
        }
        .action-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        .action-button span {
            font-size: 12px;
            font-weight: 500;
            margin-left: 6px; /* Space between text and icon */
        }
        .action-button i {
            width: 14px; /* Smaller icon */
            height: 14px; /* Smaller icon */
        }
        /* Custom scrollbar for modals */
        .modal-body::-webkit-scrollbar {
            width: 8px;
        }
        .modal-body::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .modal-body::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        .modal-body::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-slate-50">

    <div class="flex h-screen">
        <!-- Sidebar -->
        <aside class="w-64 bg-white border-l border-slate-200 flex flex-col">
            <div class="p-6 text-center border-b border-slate-200">
                <h1 class="text-xl font-bold text-slate-800">الحسابات</h1>
            </div>
            <nav class="flex-1 px-4 py-6 space-y-1">
                <a href="#" class="flex items-center px-4 py-2.5 text-slate-700 font-semibold bg-slate-100 rounded-md">
                    <i data-lucide="clock" class="w-5 h-5 ml-3 text-slate-600"></i>
                    <span>المتأخرات</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-8 overflow-y-auto">
            <header class="flex flex-wrap items-center justify-between pb-4 border-b border-slate-200 mb-6 gap-4">
                <h2 class="text-2xl font-bold text-slate-800">الفواتير المتأخرة</h2>
                <div class="flex items-center space-x-2 space-x-reverse">
                     <button class="px-4 py-2 text-sm font-medium text-white bg-slate-700 rounded-md hover:bg-slate-800 flex items-center shadow-sm">
                        <i data-lucide="plus" class="w-4 h-4 ml-2"></i>
                        <span>فاتورة جديدة</span>
                    </button>
                </div>
            </header>

            <!-- Filters and Actions -->
            <div class="bg-white p-4 rounded-lg border border-slate-200 mb-6 flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4 space-x-reverse">
                    <div class="relative">
                        <i data-lucide="search" class="absolute right-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400"></i>
                        <input type="text" placeholder="بحث..." class="w-full md:w-56 pl-4 pr-10 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500">
                    </div>
                    <div class="relative">
                         <select class="w-full md:w-40 appearance-none pl-4 pr-10 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500 bg-white">
                            <option>كل المراكز</option>
                            <option>الداخلة</option>
                            <option>الخارجة</option>
                            <option>بلاط</option>
                            <option>باريس</option>
                            <option>الفرافرة</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                    </div>
                    <div class="relative">
                         <select id="status-filter" class="w-full md:w-40 appearance-none pl-4 pr-10 py-2 border border-slate-300 rounded-md focus:outline-none focus:ring-2 focus:ring-slate-500 bg-white">
                            <option value="all">الحالة (الكل)</option>
                            <option value="paid">تم الدفع</option>
                            <option value="unpaid">لم يتم الدفع</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute left-3 top-1/2 -translate-y-1/2 w-5 h-5 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <button class="px-4 py-2 text-sm font-medium text-slate-700 bg-amber-400 rounded-md hover:bg-amber-500 flex items-center shadow-sm">
                    <i data-lucide="send" class="w-4 h-4 ml-2"></i>
                    <span>إرسال تذكير للمحدد</span>
                </button>
            </div>

            <!-- Invoices Grid -->
            <div class="bg-white rounded-lg border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-right text-slate-600">
                        <thead class="text-xs text-slate-500 uppercase bg-slate-50 border-b border-slate-200">
                            <tr>
                                <th scope="col" class="p-4">
                                    <input type="checkbox" class="form-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500">
                                </th>
                                <th scope="col" class="px-6 py-3 font-medium">رقم الفاتورة</th>
                                <th scope="col" class="px-6 py-3 font-medium">اسم العميل</th>
                                <th scope="col" class="px-6 py-3 font-medium">بند الدفع</th>
                                <th scope="col" class="px-6 py-3 font-medium">المبلغ المتأخر</th>
                                <th scope="col" class="px-6 py-3 font-medium">أيام التأخير</th>
                                <th scope="col" class="px-6 py-3 font-medium text-center">الإجراء</th>
                            </tr>
                        </thead>
                        <tbody id="invoices-tbody" class="divide-y divide-slate-200">
                            <!-- Sample Row 1 -->
                            <tr data-invoice-id="INV-001" data-status="unpaid" class="hover:bg-slate-50"
                                data-file-number="5012" data-client-name="محمد الأحمد" data-area="10 فدان"
                                data-rent-per-feddan="1500.00" data-rent-annual="15000.00" data-insurance="3000.00"
                                data-insurance-percent="20%" data-insurance-remaining="1000.00" data-receipt-date="01/01/2024"
                                data-amount-due="15000.00" data-amount-collected="10000.00" data-amount-overdue="5000.00"
                                data-notes="تم التواصل مع العميل ووعد بالسداد الأسبوع القادم." data-days-overdue="35" data-payment-item="قيمة ايجارية">
                                <td class="p-4">
                                    <input type="checkbox" class="form-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500">
                                </td>
                                <td class="px-6 py-4 font-medium text-slate-900">INV-001</td>
                                <td class="px-6 py-4">محمد الأحمد</td>
                                <td class="px-6 py-4">قيمة ايجارية</td>
                                <td class="px-6 py-4 font-semibold text-red-600">5000.00 جنيه</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">35</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex items-center justify-center space-x-2 space-x-reverse action-container">
                                        <button class="action-button pay-button" onclick="openModal('payment-modal', this)" data-invoice-id="INV-001" data-due-amount="5000.00" data-due-date="25/06/2025" data-payment-item="قيمة ايجارية"><span>دفع</span><i data-lucide="dollar-sign"></i></button>
                                        <button class="action-button" onclick="openModal('details-modal', this)"><span>عرض</span><i data-lucide="eye"></i></button>
                                        <button class="action-button" onclick="openModal('reminder-confirm-modal', this)"><span>تذكير</span><i data-lucide="bell"></i></button>
                                        <button class="action-button" onclick="openModal('history-modal', this)"><span>سجل التذكير</span><i data-lucide="history"></i></button>
                                    </div>
                                </td>
                            </tr>
                            <!-- Sample Row 2 -->
                            <tr data-invoice-id="INV-002" data-status="unpaid" class="hover:bg-slate-50"
                                data-file-number="6033" data-client-name="فاطمة الزهراء" data-area="25 فدان"
                                data-rent-per-feddan="1800.00" data-rent-annual="45000.00" data-insurance="9000.00"
                                data-insurance-percent="20%" data-insurance-remaining="0.00" data-receipt-date="15/12/2023"
                                data-amount-due="45000.00" data-amount-collected="32700.00" data-amount-overdue="12300.00"
                                data-notes="-" data-days-overdue="92" data-payment-item="تامين ابتدائي">
                                <td class="p-4">
                                    <input type="checkbox" class="form-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500">
                                </td>
                                <td class="px-6 py-4 font-medium text-slate-900">INV-002</td>
                                <td class="px-6 py-4">فاطمة الزهراء</td>
                                <td class="px-6 py-4">تامين ابتدائي</td>
                                <td class="px-6 py-4 font-semibold text-red-600">12300.00 جنيه</td>
                                <td class="px-6 py-4 text-center">
                                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded-full">92</span>
                                </td>
                                <td class="px-6 py-4 text-center">
                                    <div class="flex items-center justify-center space-x-2 space-x-reverse action-container">
                                        <button class="action-button pay-button" onclick="openModal('payment-modal', this)" data-invoice-id="INV-002" data-due-amount="12300.00" data-due-date="01/05/2025" data-payment-item="تامين ابتدائي"><span>دفع</span><i data-lucide="dollar-sign"></i></button>
                                        <button class="action-button" onclick="openModal('details-modal', this)"><span>عرض</span><i data-lucide="eye"></i></button>
                                        <button class="action-button" onclick="openModal('reminder-confirm-modal', this)"><span>تذكير</span><i data-lucide="bell"></i></button>
                                        <button class="action-button" onclick="openModal('history-modal', this)"><span>سجل التذكير</span><i data-lucide="history"></i></button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- Details Modal -->
    <div id="details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">تفاصيل الفاتورة: <span id="details-invoice-id"></span></h3>
                <button onclick="closeModal('details-modal')" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 modal-body max-h-[70vh] overflow-y-auto">
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">معلومات الفاتورة</h4>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><span class="font-semibold text-slate-500">رقم الملف:</span> <span id="details-file-number" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">اسم العميل:</span> <span id="details-client-name" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">بند الدفع:</span> <span id="details-payment-item" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">أيام التأخير:</span> <span id="details-days-overdue" class="text-slate-800 font-medium"></span></div>
                    </div>
                </div>
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">بيانات الأرض</h4>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><span class="font-semibold text-slate-500">المساحة:</span> <span id="details-area" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">القيمة الايجارية للفدان:</span> <span id="details-rent-per-feddan" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">القيمة الايجارية بالعام:</span> <span id="details-rent-annual" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">التأمين:</span> <span id="details-insurance" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">نسبة التأمين:</span> <span id="details-insurance-percent" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">الباقي من التأمين:</span> <span id="details-insurance-remaining" class="text-slate-800 font-medium"></span></div>
                        <div class="col-span-2"><span class="font-semibold text-slate-500">تاريخ الاستلام:</span> <span id="details-receipt-date" class="text-slate-800 font-medium"></span></div>
                    </div>
                </div>
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">الملخص المالي</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="p-3 bg-slate-100 rounded-md"><span class="block font-semibold text-slate-600">المبلغ المستحق</span> <span id="details-amount-due" class="block font-bold text-slate-800 text-lg"></span></div>
                        <div class="p-3 bg-emerald-50 rounded-md"><span class="block font-semibold text-emerald-700">المبلغ المحصل</span> <span id="details-amount-collected" class="block font-bold text-emerald-800 text-lg"></span></div>
                        <div class="p-3 bg-red-50 rounded-md"><span class="block font-semibold text-red-700">المبلغ المتأخر</span> <span id="details-amount-overdue" class="block font-bold text-red-800 text-lg"></span></div>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">ملاحظات</label>
                    <p id="details-notes" class="mt-1 p-3 border border-slate-200 bg-slate-50 rounded-md min-h-[60px] text-sm"></p>
                </div>
            </div>
             <div class="p-4 bg-slate-50 border-t border-slate-200 text-left">
                <button onclick="closeModal('details-modal')" class="px-5 py-2 text-sm font-medium bg-white text-slate-700 border border-slate-300 rounded-md hover:bg-slate-50 shadow-sm">إغلاق</button>
            </div>
        </div>
    </div>
    
    <!-- Investor Details Modal -->
    <div id="investor-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">تفاصيل المستثمر</h3>
                <button onclick="closeModal('investor-details-modal')" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 modal-body max-h-[70vh] overflow-y-auto">
                 <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">معلومات المستثمر</h4>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><span class="font-semibold text-slate-500">اسم العميل:</span> <span id="investor-client-name" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">رقم الملف:</span> <span id="investor-file-number" class="text-slate-800 font-medium"></span></div>
                    </div>
                </div>
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">بيانات الأرض</h4>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><span class="font-semibold text-slate-500">المساحة:</span> <span id="investor-area" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">القيمة الايجارية للفدان:</span> <span id="investor-rent-per-feddan" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">القيمة الايجارية بالعام:</span> <span id="investor-rent-annual" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">التأمين:</span> <span id="investor-insurance" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">نسبة التأمين:</span> <span id="investor-insurance-percent" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">الباقي من التأمين:</span> <span id="investor-insurance-remaining" class="text-slate-800 font-medium"></span></div>
                        <div class="col-span-2"><span class="font-semibold text-slate-500">تاريخ الاستلام:</span> <span id="investor-receipt-date" class="text-slate-800 font-medium"></span></div>
                    </div>
                </div>
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">الملخص المالي</h4>
                    <div class="grid grid-cols-3 gap-4 text-sm">
                        <div class="p-3 bg-slate-100 rounded-md"><span class="block font-semibold text-slate-600">المبلغ المستحق</span> <span id="investor-amount-due" class="block font-bold text-slate-800 text-lg"></span></div>
                        <div class="p-3 bg-emerald-50 rounded-md"><span class="block font-semibold text-emerald-700">المبلغ المحصل</span> <span id="investor-amount-collected" class="block font-bold text-emerald-800 text-lg"></span></div>
                        <div class="p-3 bg-red-50 rounded-md"><span class="block font-semibold text-red-700">المبلغ المتأخر</span> <span id="investor-amount-overdue" class="block font-bold text-red-800 text-lg"></span></div>
                    </div>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">ملاحظات</label>
                    <p id="investor-notes" class="mt-1 p-3 border border-slate-200 bg-slate-50 rounded-md min-h-[60px] text-sm"></p>
                </div>
            </div>
             <div class="p-4 bg-slate-50 border-t border-slate-200 text-left">
                <button onclick="closeModal('investor-details-modal')" class="px-5 py-2 text-sm font-medium bg-white text-slate-700 border border-slate-300 rounded-md hover:bg-slate-50 shadow-sm">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Payment Details Modal -->
    <div id="payment-details-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">تفاصيل السداد: <span id="receipt-id"></span></h3>
                <button onclick="closeModal('payment-details-modal')" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 modal-body max-h-[70vh] overflow-y-auto">
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">ملخص السداد</h4>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><span class="font-semibold text-slate-500">اسم العميل:</span> <span id="receipt-client-name" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">تاريخ الاستحقاق:</span> <span id="receipt-due-date" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">تاريخ التحصيل:</span> <span id="receipt-collection-date" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">المبلغ المحصل:</span> <span id="receipt-amount-collected" class="text-slate-800 font-medium"></span></div>
                    </div>
                </div>
                <div class="p-4 border border-slate-200 rounded-md">
                    <h4 class="font-bold text-base mb-4 text-slate-700">تفاصيل الدفعة</h4>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-3 text-sm">
                        <div><span class="font-semibold text-slate-500">طريقة الدفع:</span> <span id="receipt-payment-method" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">البند:</span> <span id="receipt-payment-item" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">غرامة مطبقة:</span> <span id="receipt-applied-fine" class="text-slate-800 font-medium"></span></div>
                        <div><span class="font-semibold text-slate-500">اسم البنك:</span> <span id="receipt-bank-name" class="text-slate-800 font-medium"></span></div>
                        <div class="col-span-2"><span class="font-semibold text-slate-500">تفاصيل التحويل:</span> <span id="receipt-transfer-details" class="text-slate-800 font-medium"></span></div>
                    </div>
                </div>
                 <div>
                    <label class="text-sm font-medium text-slate-700">المستند المرفق</label>
                    <div id="receipt-attachment" class="mt-1 p-3 border border-slate-200 bg-slate-50 rounded-md min-h-[60px] text-sm">
                    </div>
                </div>
            </div>
             <div class="p-4 bg-slate-50 border-t border-slate-200 text-left">
                <button onclick="closeModal('payment-details-modal')" class="px-5 py-2 text-sm font-medium bg-white text-slate-700 border border-slate-300 rounded-md hover:bg-slate-50 shadow-sm">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Reminder Confirm Modal -->
    <div id="reminder-confirm-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md text-center">
            <div class="p-8">
                <div class="w-16 h-16 mx-auto flex items-center justify-center bg-amber-100 rounded-full mb-4">
                    <i data-lucide="bell-ring" class="w-8 h-8 text-amber-500"></i>
                </div>
                <h3 class="text-xl font-bold text-slate-800">تأكيد إرسال التذكير</h3>
                <p class="text-slate-600 mt-2">هل أنت متأكد من إرسال تذكير للفاتورة رقم <span id="reminder-invoice-id" class="font-bold"></span>؟</p>
            </div>
            <div class="p-4 bg-slate-50 flex justify-center space-x-4 space-x-reverse">
                <button onclick="closeModal('reminder-confirm-modal')" class="px-6 py-2 text-sm font-medium bg-white text-slate-700 border border-slate-300 rounded-md hover:bg-slate-50 shadow-sm">إلغاء</button>
                <button onclick="recordReminder()" class="px-6 py-2 text-sm font-medium bg-amber-400 text-slate-800 rounded-md hover:bg-amber-500 shadow-sm">تأكيد الإرسال</button>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div id="history-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-lg">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">سجل التذكيرات: <span id="history-invoice-id"></span></h3>
                <button onclick="closeModal('history-modal')" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div id="history-modal-body" class="p-6 modal-body max-h-80 overflow-y-auto">
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 text-left">
                <button onclick="closeModal('history-modal')" class="px-5 py-2 text-sm font-medium bg-white text-slate-700 border border-slate-300 rounded-md hover:bg-slate-50 shadow-sm">إغلاق</button>
            </div>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl">
            <div class="p-5 border-b border-slate-200 flex justify-between items-center">
                <h3 class="text-lg font-bold text-slate-800">تسجيل دفعة للفاتورة: <span id="payment-invoice-id"></span></h3>
                <button onclick="closeModal('payment-modal')" class="text-slate-500 hover:text-slate-800"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 space-y-6 modal-body max-h-[70vh] overflow-y-auto">
                <div class="p-4 border border-amber-200 rounded-md bg-amber-50">
                    <h4 class="font-bold text-base mb-4 text-amber-800">حساب غرامة التأخير</h4>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                        <div>
                            <label class="text-sm font-medium text-slate-700">أصل المبلغ المستحق</label>
                            <div id="original-amount-display" class="mt-1 p-2 border border-slate-200 bg-slate-100 rounded-md">0.00</div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">أيام التأخير</label>
                            <div id="days-overdue-display" class="mt-1 p-2 border border-slate-200 bg-slate-100 rounded-md">0</div>
                        </div>
                        <div>
                            <label class="text-sm font-medium text-slate-700">قيمة الغرامة</label>
                            <div id="late-fee-display" class="mt-1 p-2 border border-slate-200 bg-slate-100 rounded-md">0.00 جنيه</div>
                        </div>
                    </div>
                     <div class="mt-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="apply-fee-checkbox" class="form-checkbox h-4 w-4 text-slate-600 border-slate-300 rounded focus:ring-slate-500">
                            <span class="mr-2 text-sm text-slate-700">تطبيق الغرامة</span>
                        </label>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4 text-sm">
                    <div><label class="font-semibold text-slate-500">تاريخ الاستحقاق:</label> <p id="due-date-display" class="font-medium text-slate-700"></p></div>
                    <div><label class="font-semibold text-slate-500">تاريخ الدفع:</label> <input type="date" id="payment-date-input" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                    <div class="p-3 bg-slate-100 rounded-md"><span class="font-semibold text-slate-600">إجمالي المستحق:</span> <span id="total-amount-display" class="font-bold text-slate-800">0.00</span></div>
                    <div class="p-3 bg-emerald-50 rounded-md"><span class="font-semibold text-emerald-700">المبلغ المحصل:</span> <input type="number" id="amount-paid-input" placeholder="0.00" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                    <div class="p-3 bg-red-50 rounded-md"><span class="font-semibold text-red-700">المبلغ المتبقي:</span> <span id="remaining-amount-display" class="font-bold text-red-800">0.00</span></div>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">بند الدفع</label>
                    <p id="payment-item-display" class="mt-1 p-2 border border-slate-200 bg-slate-100 rounded-md"></p>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">طريقة الدفع</label>
                    <select id="paymentMethod" class="mt-1 w-full p-2 border border-slate-300 rounded-md bg-white">
                        <option value="cash">نقدي</option>
                        <option value="bank">تحويل بنكي</option>
                        <option value="cheque">شيك</option>
                    </select>
                </div>
                <div id="cash-details" class="space-y-4">
                    <div><label class="text-sm font-medium text-slate-700">اسم الخزينة</label><input type="text" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                    <div><label class="text-sm font-medium text-slate-700">مسؤول الاستلام</label><input type="text" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                </div>
                <div id="bank-details" class="hidden space-y-4">
                    <div><label class="text-sm font-medium text-slate-700">اسم البنك</label><input id="bank-name-input" type="text" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                    <div><label class="text-sm font-medium text-slate-700">تفاصيل التحويل</label><textarea id="transfer-details-input" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></textarea></div>
                </div>
                <div id="cheque-details" class="hidden space-y-4">
                    <div><label class="text-sm font-medium text-slate-700">رقم الشيك</label><input type="text" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                    <div><label class="text-sm font-medium text-slate-700">تاريخ استحقاق الشيك</label><input type="date" class="mt-1 w-full p-2 border border-slate-300 rounded-md"></div>
                </div>
                <div>
                    <label class="text-sm font-medium text-slate-700">مرفقات مؤيدة للصرف</label>
                    <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-slate-300 border-dashed rounded-md">
                        <div class="space-y-1 text-center">
                            <i data-lucide="upload-cloud" class="mx-auto h-12 w-12 text-slate-400"></i>
                            <div class="flex text-sm text-slate-600">
                                <label for="file-upload" class="relative cursor-pointer bg-white rounded-md font-medium text-slate-700 hover:text-slate-600 focus-within:outline-none">
                                    <span>ارفع ملف</span>
                                    <input id="file-upload" name="file-upload" type="file" class="sr-only">
                                </label>
                                <p class="pr-1">أو اسحبه وأفلته هنا</p>
                            </div>
                            <p class="text-xs text-slate-500">PNG, JPG, PDF up to 10MB</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-50 border-t border-slate-200 flex justify-end space-x-4 space-x-reverse">
                <button onclick="closeModal('payment-modal')" class="px-5 py-2 text-sm font-medium bg-white text-slate-700 border border-slate-300 rounded-md hover:bg-slate-50 shadow-sm">إلغاء</button>
                <button onclick="recordPayment()" class="px-5 py-2 text-sm font-medium bg-green-600 text-white rounded-md hover:bg-green-700 shadow-sm">تسجيل الدفعة</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        let reminderHistory = [];
        let paymentRecords = [];
        let currentInvoiceIdForPayment = null;
        let currentInvoiceIdForReminder = null;

        function openModal(modalId, element) {
            const modal = document.getElementById(modalId);
            if (!modal) return;

            const row = element.closest('tr');
            const data = row.dataset;
            
            if (modalId === 'payment-modal') {
                currentInvoiceIdForPayment = data.invoiceId;
                document.getElementById('payment-invoice-id').textContent = data.invoiceId;
                document.getElementById('original-amount-display').textContent = parseFloat(data.amountOverdue).toFixed(2);
                document.getElementById('due-date-display').textContent = element.dataset.dueDate;
                document.getElementById('payment-item-display').textContent = data.paymentItem;
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('payment-date-input').value = today;
                document.getElementById('amount-paid-input').value = '';
                document.getElementById('apply-fee-checkbox').checked = false;
                updatePaymentDetails();
            } else if (modalId === 'details-modal' || modalId === 'investor-details-modal') {
                const prefix = modalId === 'details-modal' ? 'details' : 'investor';
                
                if (prefix === 'details') {
                    document.getElementById('details-invoice-id').textContent = data.invoiceId;
                }
                
                document.getElementById(`${prefix}-client-name`).textContent = data.clientName;
                document.getElementById(`${prefix}-file-number`).textContent = data.fileNumber;
                if(document.getElementById(`${prefix}-payment-item`)) {
                    document.getElementById(`${prefix}-payment-item`).textContent = data.paymentItem;
                }
                if(document.getElementById(`${prefix}-days-overdue`)) {
                    document.getElementById(`${prefix}-days-overdue`).textContent = data.daysOverdue;
                }
                document.getElementById(`${prefix}-area`).textContent = data.area;
                document.getElementById(`${prefix}-rent-per-feddan`).textContent = data.rentPerFeddan;
                document.getElementById(`${prefix}-rent-annual`).textContent = data.rentAnnual;
                document.getElementById(`${prefix}-insurance`).textContent = data.insurance;
                document.getElementById(`${prefix}-insurance-percent`).textContent = data.insurancePercent;
                document.getElementById(`${prefix}-insurance-remaining`).textContent = data.insuranceRemaining;
                document.getElementById(`${prefix}-receipt-date`).textContent = data.receiptDate;
                document.getElementById(`${prefix}-amount-due`).textContent = data.amountDue;
                document.getElementById(`${prefix}-amount-collected`).textContent = data.amountCollected;
                document.getElementById(`${prefix}-amount-overdue`).textContent = data.amountOverdue;
                document.getElementById(`${prefix}-notes`).textContent = data.notes;

            } else if (modalId === 'reminder-confirm-modal') {
                currentInvoiceIdForReminder = row.dataset.invoiceId;
                document.getElementById('reminder-invoice-id').textContent = row.dataset.invoiceId;
            } else if (modalId === 'history-modal') {
                document.getElementById('history-invoice-id').textContent = row.dataset.invoiceId;
                populateHistory(row.dataset.invoiceId);
            } else if (modalId === 'payment-details-modal') {
                const record = paymentRecords.find(p => p.invoiceId === row.dataset.invoiceId);
                if (record) {
                    document.getElementById('receipt-id').textContent = record.receiptId;
                    document.getElementById('receipt-client-name').textContent = record.clientName;
                    document.getElementById('receipt-due-date').textContent = record.dueDate;
                    document.getElementById('receipt-collection-date').textContent = record.collectionDate;
                    document.getElementById('receipt-amount-collected').textContent = `${record.amountCollected} جنيه`;
                    document.getElementById('receipt-payment-method').textContent = record.paymentMethod;
                    document.getElementById('receipt-payment-item').textContent = record.paymentItem;
                    document.getElementById('receipt-applied-fine').textContent = record.appliedFine ? 'نعم' : 'لا';
                    document.getElementById('receipt-bank-name').textContent = record.bankName || 'N/A';
                    document.getElementById('receipt-transfer-details').textContent = record.transferDetails || 'N/A';
                    document.getElementById('receipt-attachment').innerHTML = record.attachment ? `<a href="#" class="text-blue-600 hover:underline">${record.attachment}</a>` : 'لا يوجد مرفق';
                }
            }

            modal.classList.add('is-open');
            window.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') closeModal(modalId);
            }, { once: true });
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) modal.classList.remove('is-open');
        }
        
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeModal(modal.id);
            });
        });

        const paymentMethodSelect = document.getElementById('paymentMethod');
        const cashDetails = document.getElementById('cash-details');
        const bankDetails = document.getElementById('bank-details');
        const chequeDetails = document.getElementById('cheque-details');

        paymentMethodSelect.addEventListener('change', (e) => {
            cashDetails.classList.add('hidden');
            bankDetails.classList.add('hidden');
            chequeDetails.classList.add('hidden');
            const selectedMethod = e.target.value;
            if (selectedMethod === 'cash') cashDetails.classList.remove('hidden');
            else if (selectedMethod === 'bank') bankDetails.classList.remove('hidden');
            else if (selectedMethod === 'cheque') chequeDetails.classList.remove('hidden');
        });

        const dueDateEl = document.getElementById('due-date-display');
        const paymentDateInput = document.getElementById('payment-date-input');
        const daysOverdueDisplay = document.getElementById('days-overdue-display');
        const originalAmountDisplay = document.getElementById('original-amount-display');
        const lateFeeDisplay = document.getElementById('late-fee-display');
        const applyFeeCheckbox = document.getElementById('apply-fee-checkbox');
        const totalAmountDisplay = document.getElementById('total-amount-display');
        const amountPaidInput = document.getElementById('amount-paid-input');
        const remainingAmountDisplay = document.getElementById('remaining-amount-display');
        
        const LATE_FEE_INTEREST_RATE = 0.10;

        function updatePaymentDetails() {
            if (!dueDateEl.textContent || !paymentDateInput.value) return;
            const dueDateParts = dueDateEl.textContent.split('/');
            const dueDate = new Date(`${dueDateParts[2]}-${dueDateParts[1]}-${dueDateParts[0]}`);
            const paymentDate = new Date(paymentDateInput.value);
            let daysOverdue = 0;
            if (paymentDate > dueDate) {
                daysOverdue = Math.ceil((paymentDate - dueDate) / (1000 * 60 * 60 * 24));
            }
            daysOverdueDisplay.textContent = daysOverdue;

            const originalAmount = parseFloat(originalAmountDisplay.textContent);
            const lateFee = (originalAmount * LATE_FEE_INTEREST_RATE * daysOverdue) / 365;
            lateFeeDisplay.textContent = `${lateFee.toFixed(2)} جنيه`;

            let totalAmount = originalAmount;
            if (applyFeeCheckbox.checked) totalAmount += lateFee;
            totalAmountDisplay.textContent = totalAmount.toFixed(2);

            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            const remainingAmount = totalAmount - amountPaid;
            remainingAmountDisplay.textContent = remainingAmount.toFixed(2);
        }

        [paymentDateInput, amountPaidInput, applyFeeCheckbox].forEach(el => el.addEventListener('input', updatePaymentDetails));
        
        function recordPayment() {
            if (!currentInvoiceIdForPayment) return;
            
            const row = document.querySelector(`tr[data-invoice-id="${currentInvoiceIdForPayment}"]`);
            if (row) {
                const receiptNumber = `REC-${String(paymentRecords.length + 1).padStart(3, '0')}`;
                const paymentRecord = {
                    receiptId: receiptNumber,
                    invoiceId: currentInvoiceIdForPayment,
                    clientName: row.dataset.clientName,
                    dueDate: document.getElementById('due-date-display').textContent,
                    collectionDate: new Date(document.getElementById('payment-date-input').value).toLocaleDateString('ar-EG'),
                    amountCollected: parseFloat(document.getElementById('amount-paid-input').value).toFixed(2),
                    paymentMethod: document.getElementById('paymentMethod').options[document.getElementById('paymentMethod').selectedIndex].text,
                    paymentItem: document.getElementById('payment-item-display').textContent,
                    appliedFine: document.getElementById('apply-fee-checkbox').checked,
                    bankName: document.getElementById('paymentMethod').value === 'bank' ? document.getElementById('bank-name-input').value : null,
                    transferDetails: document.getElementById('paymentMethod').value === 'bank' ? document.getElementById('transfer-details-input').value : null,
                    attachment: document.getElementById('file-upload').files[0]?.name || null
                };
                paymentRecords.push(paymentRecord);

                row.dataset.status = 'paid';
                
                const actionContainer = row.querySelector('.action-container');
                if (actionContainer) {
                    actionContainer.innerHTML = `
                        <button class="action-button" onclick="openModal('payment-details-modal', this)"><span>عرض السداد</span><i data-lucide="receipt"></i></button>
                        <button class="action-button" onclick="openModal('investor-details-modal', this)"><span>تفاصيل المستثمر</span><i data-lucide="user-circle"></i></button>
                    `;
                    lucide.createIcons();
                }
            }
            
            closeModal('payment-modal');
            document.getElementById('status-filter').dispatchEvent(new Event('change'));
        }
        
        function recordReminder() {
            if (!currentInvoiceIdForReminder) return;
            reminderHistory.push({
                invoiceId: currentInvoiceIdForReminder,
                user: 'مدير النظام',
                timestamp: new Date().toLocaleString('ar-EG', { dateStyle: 'short', timeStyle: 'short' })
            });
            closeModal('reminder-confirm-modal');
        }

        function populateHistory(invoiceId) {
            const historyBody = document.getElementById('history-modal-body');
            const relevantHistory = reminderHistory.filter(entry => entry.invoiceId === invoiceId);

            if (relevantHistory.length === 0) {
                historyBody.innerHTML = `<p class="text-slate-500 text-center">لا يوجد سجل تذكيرات لهذه الفاتورة.</p>`;
                return;
            }

            let historyHtml = '<ul class="space-y-4">';
            relevantHistory.forEach(entry => {
                historyHtml += `
                    <li class="flex items-start space-x-4 space-x-reverse">
                        <div class="bg-slate-100 p-2 rounded-full"><i data-lucide="user" class="w-5 h-5 text-slate-600"></i></div>
                        <div>
                            <p class="font-semibold text-slate-800">${entry.user}</p>
                            <p class="text-sm text-slate-500">${entry.timestamp} - تم إرسال تذكير.</p>
                        </div>
                    </li>`;
            });
            historyHtml += '</ul>';
            historyBody.innerHTML = historyHtml;
            lucide.createIcons();
        }

        const statusFilter = document.getElementById('status-filter');
        statusFilter.addEventListener('change', (e) => {
            const selectedStatus = e.target.value;
            document.querySelectorAll('#invoices-tbody tr').forEach(row => {
                const rowStatus = row.dataset.status;
                row.style.display = (selectedStatus === 'all' || rowStatus === selectedStatus) ? '' : 'none';
            });
        });

    </script>
</body>
</html>
